<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Man of the Match</title>

  <!-- QRCode generator -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <!-- Firebase SDKs -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import {
      getFirestore,
      collection,
      doc,
      setDoc,
      getDoc,
      onSnapshot
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    // âœ… Your Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyBqrlHZG_ZejqNKF97momPHTF9d-GlUTg",
      authDomain: "motm--pumas.firebaseapp.com",
      projectId: "motm--pumas",
      storageBucket: "motm--pumas.firebasestorage.app",
      messagingSenderId: "953454926915",
      appId: "1:953454926915:web:8744eeef4bf9d967e488f6"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Utility for random code
    function makeCode(len = 6) {
      const chars = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
      let result = "";
      for (let i = 0; i < len; i++) result += chars[Math.floor(Math.random() * chars.length)];
      return result;
    }

    const teamNameInput = document.getElementById("teamName");
    const matchCodeInput = document.getElementById("matchCode");
    const playersList = document.getElementById("playersList");
    const voteList = document.getElementById("voteList");
    const newMatchBtn = document.getElementById("newMatch");
    const resetBtn = document.getElementById("resetVotes");
    const joinBtn = document.getElementById("joinBtn");
    const shareLink = document.getElementById("shareLink");
    const qrContainer = document.getElementById("qr");

    let currentCode = null;
    let unsubscribe = null;

    async function createMatch() {
      const code = makeCode();
      currentCode = code;
      matchCodeInput.value = code;

      await setDoc(doc(collection(db, "matches"), code), {
        team: teamNameInput.value || "Untitled Team",
        created: new Date().toISOString(),
        players: [],
        votes: {}
      });

      updateShareLink(code);
      listenForChanges(code);
    }

    function updateShareLink(code) {
      const url = `${location.origin}?match=${code}`;
      shareLink.value = url;
      qrContainer.innerHTML = "";
      new QRCode(qrContainer, { text: url, width: 128, height: 128 });
    }

    async function joinMatch() {
      const code = matchCodeInput.value.trim().toUpperCase();
      if (!code) return alert("Enter a match code");
      currentCode = code;
      listenForChanges(code);
      updateShareLink(code);
    }

    function listenForChanges(code) {
      if (unsubscribe) unsubscribe();
      const ref = doc(db, "matches", code);
      unsubscribe = onSnapshot(ref, (snap) => {
        const data = snap.data();
        if (!data) return;
        teamNameInput.value = data.team;
        renderPlayers(data.players || []);
        renderVotes(data.votes || {});
      });
    }

    function renderPlayers(players) {
      playersList.innerHTML = players
        .map((p) => `<div>${p.number}. ${p.name}</div>`)
        .join("");
    }

    function renderVotes(votes) {
      const counts = {};
      Object.values(votes).forEach((v) => {
        counts[v] = (counts[v] || 0) + 1;
      });
      const sorted = Object.entries(counts).sort((a, b) => b[1] - a[1]);
      voteList.innerHTML = sorted
        .map(([name, count]) => `<div>${name}: ${count} votes</div>`)
        .join("");
    }

    async function resetVotes() {
      if (!currentCode) return alert("No match active");
      await setDoc(
        doc(collection(db, "matches"), currentCode),
        { votes: {} },
        { merge: true }
      );
    }

    // UI event handlers
    newMatchBtn.onclick = createMatch;
    joinBtn.onclick = joinMatch;
    resetBtn.onclick = resetVotes;

    // Online indicator
    window.addEventListener("online", () => {
      document.getElementById("status").textContent = "ðŸŸ¢ You are online. Live syncing enabled.";
    });
    window.addEventListener("offline", () => {
      document.getElementById("status").textContent = "ðŸ”´ You are offline. Changes will sync when back online.";
    });

    document.getElementById("status").textContent = navigator.onLine
      ? "ðŸŸ¢ You are online. Live syncing enabled."
      : "ðŸ”´ You are offline. Changes will sync when back online.";
  </script>

  <style>
    body {
      font-family: system-ui, sans-serif;
      background: #fafafa;
      color: #222;
      margin: 0;
      padding: 1.5rem;
    }
    h1 {
      text-align: center;
    }
    section {
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      margin: 1rem auto;
      padding: 1rem;
      max-width: 700px;
    }
    input, button {
      font-size: 1rem;
      padding: 0.5rem;
      margin: 0.3rem;
    }
    button {
      border: none;
      border-radius: 6px;
      background: #000;
      color: #fff;
      cursor: pointer;
    }
    button:hover {
      background: #333;
    }
    #qr {
      margin-top: 0.5rem;
    }
    .section-title {
      font-weight: bold;
      margin-top: 1rem;
    }
  </style>
</head>
<body>
  <h1>Man of the Match</h1>

  <section>
    <div id="status">Connecting...</div>
  </section>

  <section>
    <div class="section-title">Team setup</div>
    <input id="teamName" placeholder="Team name" />
    <input id="matchCode" placeholder="Match code" />
    <button id="joinBtn">Join</button>
    <button id="newMatch">New match</button>
    <button id="resetVotes">Reset votes</button>

    <div style="margin-top:1rem;">
      <div>Share link:</div>
      <input id="shareLink" readonly style="width:90%" />
      <div id="qr"></div>
    </div>
  </section>

  <section>
    <div class="section-title">Players</div>
    <div id="playersList">No players yet</div>
  </section>

  <section>
    <div class="section-title">Votes</div>
    <div id="voteList">No votes yet</div>
  </section>
</body>
</html>


