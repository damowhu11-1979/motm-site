<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Man of the Match</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; background:#fafafa; color:#222; margin:0; padding:1.5rem; }
    h1 { text-align:center; margin:0 0 1rem; }
    section { background:#fff; border-radius:12px; box-shadow:0 2px 6px rgba(0,0,0,.08); margin:1rem auto; padding:1rem; max-width:720px; }
    .row { display:flex; flex-wrap:wrap; gap:.5rem; align-items:center; }
    input, button { font-size:1rem; padding:.6rem .75rem; border-radius:8px; border:1px solid #ddd; }
    input { flex:1 1 220px; }
    button { background:#000; color:#fff; border:none; cursor:pointer; }
    button:hover { background:#333; }
    #qr { margin-top:.75rem; }
    .label { font-weight:600; margin:.25rem 0; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
    .muted { color:#666; font-size:.9rem; }
    .err { background:#fee2e2; border:1px solid #ef4444; color:#991b1b; padding:.6rem .75rem; border-radius:8px; margin:.5rem 0; }
  </style>
  <!-- Optional QR library (if blocked, we auto-fallback to an <img>) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js" defer></script>
</head>
<body>
  <h1>Man of the Match</h1>

  <section>
    <div id="status">Connectingâ€¦</div>
  </section>

  <section>
    <div class="label">Team setup</div>
    <div class="row" style="margin:.25rem 0 0">
      <input id="teamName" placeholder="Team name" />
      <input id="matchCode" class="mono" placeholder="Match code" />
      <button id="joinBtn" title="Join a match by code">Join</button>
      <button id="newMatch" title="Create a new match and code">New match</button>
      <button id="resetVotes" title="Clear all votes for this match">Reset votes</button>
    </div>

    <div style="margin-top:1rem;">
      <div class="label">Share link</div>
      <input id="shareLink" class="mono" readonly style="width:100%" />
      <div id="qr"></div>
      <div id="qrMsg" class="muted"></div>
    </div>
  </section>

  <section>
    <div class="label">Players</div>
    <div id="playersList" class="muted">No players yet</div>
  </section>

  <section>
    <div class="label">Votes</div>
    <div id="voteList" class="muted">No votes yet</div>
  </section>

  <!-- App logic -->
  <script type="module">
    // Wait for DOM to exist
    window.addEventListener('DOMContentLoaded', init);

    async function init() {
      // Import Firebase after DOM is ready
      const [{ initializeApp }, firestorePkg] = await Promise.all([
        import("https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js"),
        import("https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js")
      ]);
      const { getFirestore, collection, doc, setDoc, getDoc, onSnapshot } = firestorePkg;

      // --- Your Firebase config ---
      const firebaseConfig = {
        apiKey: "AIzaSyBqrlHZG_ZejqNKF97momPHTF9d-GlUTg",
        authDomain: "motm--pumas.firebaseapp.com",
        projectId: "motm--pumas",
        storageBucket: "motm--pumas.firebasestorage.app",
        messagingSenderId: "953454926915",
        appId: "1:953454926915:web:8744eeef4bf9d967e488f6"
      };

      // --- DOM refs ---
      const teamNameInput = document.getElementById("teamName");
      const matchCodeInput = document.getElementById("matchCode");
      const playersList   = document.getElementById("playersList");
      const voteList      = document.getElementById("voteList");
      const newMatchBtn   = document.getElementById("newMatch");
      const resetBtn      = document.getElementById("resetVotes");
      const joinBtn       = document.getElementById("joinBtn");
      const shareLink     = document.getElementById("shareLink");
      const qrContainer   = document.getElementById("qr");
      const qrMsg         = document.getElementById("qrMsg");

      // --- Init Firebase ---
      const app = initializeApp(firebaseConfig);
      const db  = getFirestore(app);

      // --- Utils ---
      function makeCode(len = 6) {
        const chars = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
        let out = "";
        for (let i = 0; i < len; i++) out += chars[(Math.random() * chars.length) | 0];
        return out;
      }
      function setStatus() {
        document.getElementById("status").textContent =
          navigator.onLine
            ? "ðŸŸ¢ You are online. Live syncing enabled."
            : "ðŸ”´ You are offline. Changes will sync when back online.";
      }

      function renderQR(text) {
        qrContainer.innerHTML = "";
        // Try in-page library first
        if (typeof window.QRCode === "function") {
          try {
            new window.QRCode(qrContainer, { text, width: 160, height: 160 });
            qrMsg.className = "muted";
            qrMsg.textContent = "Scan to join this match.";
            return;
          } catch {}
        }
        // Fallback to image-based QR if library is blocked
        const img = new Image();
        img.width = 160;
        img.height = 160;
        img.alt = "QR";
        img.src = "https://api.qrserver.com/v1/create-qr-code/?size=160x160&data=" + encodeURIComponent(text);
        qrContainer.appendChild(img);
        qrMsg.className = "muted";
        qrMsg.textContent = "QR rendered via fallback service.";
      }

      function updateShareLink(code) {
        const url = `${location.origin}?match=${code}`;
        shareLink.value = url;
        renderQR(url);
      }

      let currentCode = null;
      let unsubscribe = null;

      async function createMatch() {
        const code = makeCode();
        currentCode = code;
        matchCodeInput.value = code;

        await setDoc(doc(collection(db, "matches"), code), {
          team: teamNameInput.value || "Untitled Team",
          created: new Date().toISOString(),
          players: [],
          votes: {}
        });

        updateShareLink(code);
        listenForChanges(code);
      }

      async function joinMatch() {
        const code = (matchCodeInput.value || "").trim().toUpperCase();
        if (!code) { alert("Enter a match code"); return; }
        currentCode = code;
        updateShareLink(code);
        listenForChanges(code);
      }

      function listenForChanges(code) {
        if (unsubscribe) unsubscribe();
        const ref = doc(db, "matches", code);
        unsubscribe = onSnapshot(ref, (snap) => {
          const data = snap.data();
          if (!data) return;
          teamNameInput.value = data.team || "";
          renderPlayers(data.players || []);
          renderVotes(data.votes || {});
        });
      }

      function renderPlayers(players) {
        playersList.innerHTML = players.length
          ? players.map(p => `<div>${p.number}. ${p.name}</div>`).join("")
          : "No players yet";
      }

      function renderVotes(votes) {
        const counts = {};
        Object.values(votes).forEach(v => { counts[v] = (counts[v] || 0) + 1; });
        const sorted = Object.entries(counts).sort((a,b)=> b[1]-a[1]);
        voteList.innerHTML = sorted.length
          ? sorted.map(([name, n]) => `<div>${name}: ${n} vote${n===1?"":"s"}</div>`).join("")
          : "No votes yet";
      }

      async function resetVotes() {
        if (!currentCode) { alert("No match active"); return; }
        await setDoc(doc(collection(db, "matches"), currentCode), { votes: {} }, { merge: true });
      }

      // Events
      newMatchBtn.addEventListener("click", createMatch);
      joinBtn.addEventListener("click", joinMatch);
      resetBtn.addEventListener("click", resetVotes);

      window.addEventListener("online", setStatus);
      window.addEventListener("offline", setStatus);
      setStatus();

      // If arriving with ?match=CODE, auto-join
      const params = new URLSearchParams(location.search);
      const incoming = (params.get("match") || "").toUpperCase();
      if (incoming) {
        matchCodeInput.value = incoming;
        updateShareLink(incoming);
        listenForChanges(incoming);
      }
    }
  </script>
</body>
</html>
